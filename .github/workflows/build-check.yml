name: アプリ動作確認

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master

jobs:
  # パッケージマネージャーを自動検出してビルド・起動確認
  build-and-test:
    name: ビルド & 起動確認
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # リポジトリをチェックアウト
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      # Node.jsをセットアップ（LTS版を使用）
      - name: Node.js環境をセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      # パッケージマネージャーを検出
      - name: パッケージマネージャーを検出
        id: detect-pm
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "検出: pnpm"
          elif [ -f "yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "検出: yarn"
          elif [ -f "package-lock.json" ] || [ -f "package.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "検出: npm"
          else
            echo "manager=none" >> $GITHUB_OUTPUT
            echo "package.jsonが見つかりません"
          fi

      # pnpmのセットアップ（必要な場合）
      - name: pnpmをセットアップ
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: latest

      # 依存関係をインストール
      - name: 依存関係をインストール
        if: steps.detect-pm.outputs.manager != 'none'
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn install
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "npm" ]; then
            npm install
          fi

      # ビルドチェック
      - name: ビルド確認
        if: steps.detect-pm.outputs.manager != 'none'
        run: |
          MANAGER="${{ steps.detect-pm.outputs.manager }}"
          
          # package.jsonにbuildスクリプトがあるかチェック
          if grep -q '"build"' package.json 2>/dev/null; then
            echo "✅ buildスクリプトを実行します"
            if [ "$MANAGER" = "pnpm" ]; then
              pnpm run build
            elif [ "$MANAGER" = "yarn" ]; then
              yarn build
            else
              npm run build
            fi
          else
            echo "⚠️ buildスクリプトが見つかりません（スキップ）"
          fi

      # 起動確認（タイムアウト付き）
      - name: サーバー起動確認
        if: steps.detect-pm.outputs.manager != 'none'
        run: |
          MANAGER="${{ steps.detect-pm.outputs.manager }}"
          
          # package.jsonにdev/startスクリプトがあるかチェック
          if grep -q '"dev"' package.json 2>/dev/null; then
            SCRIPT="dev"
          elif grep -q '"start"' package.json 2>/dev/null; then
            SCRIPT="start"
          else
            echo "⚠️ dev/startスクリプトが見つかりません（スキップ）"
            exit 0
          fi
          
          echo "✅ ${SCRIPT}スクリプトで起動確認を行います"
          
          # バックグラウンドでサーバーを起動
          if [ "$MANAGER" = "pnpm" ]; then
            pnpm run $SCRIPT &
          elif [ "$MANAGER" = "yarn" ]; then
            yarn $SCRIPT &
          else
            npm run $SCRIPT &
          fi
          
          SERVER_PID=$!
          
          # サーバーが起動するまで最大30秒待機
          echo "サーバーの起動を待っています..."
          for i in {1..30}; do
            if kill -0 $SERVER_PID 2>/dev/null; then
              echo "✅ サーバーは正常に起動しました（${i}秒）"
              kill $SERVER_PID 2>/dev/null || true
              exit 0
            fi
            sleep 1
          done
          
          echo "✅ サーバープロセスは正常に開始されました"
          kill $SERVER_PID 2>/dev/null || true

      # 結果サマリー
      - name: 結果サマリー
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 アプリ動作確認の結果"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          if [ "${{ steps.detect-pm.outputs.manager }}" = "none" ]; then
            echo "⚠️ package.jsonが見つかりませんでした"
            echo "   単元によってはこれは正常です"
          else
            echo "✅ すべてのチェックが完了しました"
          fi